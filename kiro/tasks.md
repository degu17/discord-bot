# 実装計画

- [ ] 1. 型定義とインターフェースの作成

  - TypeScript型定義ファイルを作成し、モデレーション機能の基本的なインターフェースを定義する
  - ModerationAction enum、DetectionResult、LogEntry等の型を定義する
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1_

- [ ] 2. ConfigManagerの実装
  - 設定ファイル読み込み機能を実装する
  - JSON設定ファイルのバリデーション機能を追加する
  - エラーハンドリングとデフォルト設定のフォールバック機能を実装する
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 3. WordDetectorの実装
  - 不適切語検出ロジックを実装する
  - 設定ファイルからルールを読み込み、メッセージ内容をチェックする機能を作成する
  - 検出レベルの判定とDetectionResultの生成機能を実装する
  - _要件: 1.1, 2.1, 3.1_

- [ ] 4. ModerationLoggerの実装
  - ログエントリの作成と永続化機能を実装する
  - ログファイルのローテーション機能を追加する
  - ログ記録失敗時のエラーハンドリングを実装する
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 5. ActionExecutorの実装
- [ ] 5.1 警告メッセージ送信機能の実装
  - レベル1検出時の警告メッセージ表示機能を作成する
  - Discord APIを使用したメッセージ送信処理を実装する
  - _要件: 1.1, 1.2, 1.3_

- [ ] 5.2 メッセージ削除機能の実装
  - レベル2検出時のメッセージ削除機能を作成する
  - 削除通知メッセージの送信機能を実装する
  - 削除失敗時の管理者通知機能を追加する
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ] 5.3 ユーザータイムアウト機能の実装
  - レベル3検出時のユーザータイムアウト機能を作成する
  - タイムアウト実行とメッセージ削除の組み合わせ処理を実装する
  - タイムアウト失敗時の管理者通知機能を追加する
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 6. ModerationServiceの実装
  - メインのモデレーションサービスクラスを作成する
  - WordDetector、ActionExecutor、ModerationLoggerを統合する
  - メッセージ処理のメインフローを実装する
  - _要件: 1.1, 2.1, 3.1, 5.1_

- [ ] 7. 既存DiscordBotクラスとの統合
  - lib/discord.tsのMessageCreateイベントハンドラーを拡張する
  - ModerationServiceのインスタンス化と呼び出し処理を追加する
  - ボット自身のメッセージをスキップする処理を実装する
  - _要件: 1.1, 2.1, 3.1_

- [ ] 8. エラーハンドリングの実装
  - Discord API呼び出し失敗時のリトライ機能を実装する
  - 設定ファイル読み込みエラーの処理を追加する
  - ログ記録失敗時のフォールバック処理を実装する
  - _要件: 2.4, 3.4, 4.4, 5.4_

- [ ] 9. 単体テストの作成
- [ ] 9.1 WordDetectorのテスト作成
  - 各レベルの検出語テストケースを作成する
  - 検出結果の正確性を検証するテストを実装する
  - _要件: 1.1, 2.1, 3.1_

- [ ] 9.2 ActionExecutorのテスト作成
  - モックDiscord APIを使用したテストを作成する
  - 各アクション実行の成功・失敗ケースをテストする
  - _要件: 1.1, 2.1, 3.1_

- [ ] 9.3 ConfigManagerのテスト作成
  - 設定ファイル読み込みとバリデーションのテストを作成する
  - エラーハンドリングのテストケースを実装する
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 10. 統合テストの作成
  - 実際のメッセージイベントをシミュレートするテストを作成する
  - 各レベルのモデレーション処理の統合テストを実装する
  - エンドツーエンドのモデレーションフローをテストする
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3_

- [ ] 11. ログディレクトリとファイル構造の設定
  - プロジェクトルートにlogs/moderation/ディレクトリを作成する
  - ログファイルの命名規則と管理機能を実装する
  - ログローテーション機能の動作確認を行う
  - _要件: 5.1, 5.2, 5.3_

- [ ] 12. 設定ファイルの拡張と検証
  - 既存のmoderationRules.jsonに必要な設定項目を追加する
  - 設定ファイルの形式検証とデフォルト値の設定を実装する
  - 設定変更時の動的リロード機能をテストする
  - _要件: 4.1, 4.2, 4.3, 4.4_